[gd_scene load_steps=14 format=2]

[ext_resource path="res://components/event_processor.tscn" type="PackedScene" id=1]
[ext_resource path="res://images/ui/paused.png" type="Texture" id=2]
[ext_resource path="res://images/ui/cursor/cursor_outside.png" type="Texture" id=3]
[ext_resource path="res://images/ui/cursor/cursor_inside.png" type="Texture" id=4]
[ext_resource path="res://components/rect_stripe.tscn" type="PackedScene" id=5]
[ext_resource path="res://shaders/hue_shift.shader" type="Shader" id=6]
[ext_resource path="res://scripts/cursor_diamond.gd" type="Script" id=7]
[ext_resource path="res://audio/sfx/confirmation_001.ogg" type="AudioStream" id=8]

[sub_resource type="GDScript" id=1]
script/source = "extends \"res://scripts/base_scene.gd\"
"

[sub_resource type="GDScript" id=2]
script/source = "extends TextureRect

func _input(event):
	if (self.visible):
		if event.is_action_pressed(\"ui_cancel\"):
			$PauseTween.remove_all()
			$PauseTween.interpolate_property(self, 'modulate:a', 1, 0, 0.1, Tween.TRANS_LINEAR, Tween.EASE_OUT_IN)
			$PauseTween.start()

func _on_tween_all_completed():
	self.visible = false

func _on_visibility_changed():
	if (self.visible):
		# make sure we're really visible
		self.modulate.a = 1
	else:
		get_tree().paused = false
"

[sub_resource type="ShaderMaterial" id=4]
shader = ExtResource( 6 )
shader_param/shift_amount = null

[sub_resource type="ShaderMaterial" id=5]
shader = ExtResource( 6 )
shader_param/shift_amount = null

[sub_resource type="GDScript" id=6]
script/source = "extends CanvasLayer

var active_text: String
var rect_stripe_active: bool = false
onready var stripe = $RectStripe
onready var microtimer = $Microtimer

func _is_event_processor_active(): return self.get_parent().check_event_processor_active()

func _process(_delta):
	if (self._is_event_processor_active() && self.rect_stripe_active && self.active_text):
		self.temp_hide_rect_stripe()
	elif (!self._is_event_processor_active() && !self.rect_stripe_active && self.active_text):
		self.reshow_rect_stripe()

func temp_hide_rect_stripe():
	self.rect_stripe_active = false
	self.stripe.hide_rect_stripe()

func reshow_rect_stripe():
	self.rect_stripe_active = true
	self._on_CursorLayer_show_info_text(self.active_text)

func _on_CursorLayer_show_info_text(text):
	# calculate rect size by simulating it on a dummy node
	if (text != self.stripe.rect_calculator.text):
		self.stripe.rect_calculator.text = \"\"
		self.stripe.rect_calculator.rect_size = Vector2(0, self.stripe.rect_calculator.rect_size.y)
		self.stripe.rect_calculator.text = text
		self.stripe.rect_calculator.visible_characters = -1
		self.microtimer.start(); yield(self.microtimer, \"timeout\")
	
	self.active_text = text
	var length: int = 110 + int(self.stripe.rect_calculator.rect_size.x)
	
	# return if event processor is active
	if self._is_event_processor_active(): return
	# else, animate showing
	self.stripe.show_rect_stripe(length, text)
	self.rect_stripe_active = true

func _on_CursorLayer_hide_info_text(text = \"\"):
	self.microtimer.start(); yield(self.microtimer, \"timeout\")
	self.active_text = \"\"
	self.stripe.hide_rect_stripe()
	self.rect_stripe_active = false
"

[node name="BaseScene" type="Node"]
script = SubResource( 1 )

[node name="PausedUILayer" type="CanvasLayer" parent="."]
layer = 10

[node name="PausedIndicator" type="TextureRect" parent="PausedUILayer"]
pause_mode = 2
visible = false
margin_right = 1920.0
margin_bottom = 1080.0
mouse_filter = 0
texture = ExtResource( 2 )
expand = true
stretch_mode = 7
script = SubResource( 2 )
__meta__ = {
"_edit_use_anchors_": false
}

[node name="PauseTween" type="Tween" parent="PausedUILayer/PausedIndicator"]

[node name="EventProcessor" parent="." instance=ExtResource( 1 )]

[node name="CursorLayer" type="CanvasLayer" parent="."]
pause_mode = 2
layer = 20
script = ExtResource( 7 )

[node name="CursorSprite" type="Node2D" parent="CursorLayer"]
modulate = Color( 1, 1, 1, 0.843137 )
position = Vector2( -512, -512 )
z_index = 200
z_as_relative = false
__meta__ = {
"_edit_group_": true
}

[node name="CursorSpriteOutside" type="Sprite" parent="CursorLayer/CursorSprite"]
material = SubResource( 4 )
scale = Vector2( 0.08, 0.08 )
texture = ExtResource( 3 )

[node name="CursorSpriteInside" type="Sprite" parent="CursorLayer/CursorSprite"]
material = SubResource( 5 )
scale = Vector2( 0.105, 0.105 )
texture = ExtResource( 4 )

[node name="InfoLayer" type="CanvasLayer" parent="."]
script = SubResource( 6 )

[node name="Microtimer" type="Timer" parent="InfoLayer"]
wait_time = 0.1
one_shot = true

[node name="RectStripe" parent="InfoLayer" instance=ExtResource( 5 )]

[node name="BaseCamera" type="Camera2D" parent="."]
position = Vector2( 960, 540 )
rotating = true
current = true

[node name="Audio" type="Node" parent="."]

[node name="Confirm" type="AudioStreamPlayer" parent="Audio"]
stream = ExtResource( 8 )
bus = "UI"

[connection signal="visibility_changed" from="PausedUILayer/PausedIndicator" to="PausedUILayer/PausedIndicator" method="_on_visibility_changed"]
[connection signal="tween_all_completed" from="PausedUILayer/PausedIndicator/PauseTween" to="PausedUILayer/PausedIndicator" method="_on_tween_all_completed"]
[connection signal="hover_off" from="EventProcessor" to="CursorLayer" method="_off_hover"]
[connection signal="hover_on" from="EventProcessor" to="CursorLayer" method="_on_hover"]
[connection signal="hide_info_text" from="CursorLayer" to="InfoLayer" method="_on_CursorLayer_hide_info_text"]
[connection signal="show_info_text" from="CursorLayer" to="InfoLayer" method="_on_CursorLayer_show_info_text"]
